<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wallet - Femzy</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/chatbot.css" />
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="logo">
          <div class="logo-icon">F</div>
          <span>Femzy</span>
        </div>
        <div class="nav-links">
          <a href="index.html" class="nav-link">üè† Dashboard</a>
          <a href="wallet.html" class="nav-link active">üí∞ Wallet</a>
        </div>
      </div>
      <div class="nav-right">
        <div class="balance-badge" id="balanceDisplay">‚Ç¶0.00</div>
        <button class="theme-toggle" id="themeToggle">üåô</button>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Menu</div>
        <a href="index.html" class="sidebar-link">
          <span class="sidebar-icon">üè†</span>
          <span>Dashboard</span>
        </a>
        <a href="wallet.html" class="sidebar-link active">
          <span class="sidebar-icon">üí∞</span>
          <span>Wallet</span>
        </a>
        <a href="profile.html" class="sidebar-link">
          <span class="sidebar-icon">üë§</span>
          <span>Profile</span>
        </a>
        <a href="#" class="sidebar-link" id="contactLink">
          <span class="sidebar-icon">üìû</span>
          <span>Contact Us</span>
        </a>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Account</div>
        <a href="#" class="sidebar-link" id="logoutBtn">
          <span class="sidebar-icon">üö™</span>
          <span>Log Out</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Wallet</h1>
        <p>Manage your balance and view transaction history</p>
      </div>

      <!-- Balance Card -->
      <div
        class="content-section"
        style="
          background: linear-gradient(135deg, #00d4aa, #00b894);
          color: white;
          padding: 40px;
        "
      >
        <h2 style="font-size: 16px; margin-bottom: 15px; opacity: 0.9">
          Current Balance
        </h2>
        <div
          style="font-size: 48px; font-weight: 700; margin-bottom: 20px"
          id="walletBalance"
        >
          ‚Ç¶0.00
        </div>
        <button
          class="btn"
          style="background: white; color: #00d4aa"
          id="addFundsBtn"
        >
          + Add Funds
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Total Added</span>
            <div class="stat-icon" style="background: #e0f7f4; color: #00d4aa">
              üìà
            </div>
          </div>
          <div class="stat-value" id="totalAdded">‚Ç¶0.00</div>
          <div class="stat-change positive">
            <span>‚Üó</span>
            <span>All time</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Total Spent</span>
            <div class="stat-icon" style="background: #fce4ec; color: #e91e63">
              üìâ
            </div>
          </div>
          <div class="stat-value" id="totalSpent">‚Ç¶0</div>
          <div class="stat-change">
            <span>‚Äî</span>
            <span>All time</span>
          </div>
        </div>
      </div>

      <!-- Promo Code -->
      <div class="content-section">
        <h2 class="section-title">Have a Promo Code?</h2>
        <div style="display: flex; gap: 10px; margin-top: 20px">
          <input
            type="text"
            class="form-input"
            placeholder="Enter promo code"
            id="promoCodeInput"
            style="flex: 1"
          />
          <button class="btn btn-primary" id="applyPromoBtn">Apply</button>
        </div>
        <div id="promoMessage" style="margin-top: 10px; display: none"></div>
      </div>

      <!-- Transaction History -->
      <div class="content-section">
        <div class="section-header">
          <h2 class="section-title">Transaction History</h2>
        </div>
        <div class="table-container" id="transactionsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No transactions yet</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Funds Modal -->
    <div
      id="addFundsModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 16px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        "
      >
        <h2 style="margin-bottom: 20px; margin-top: 0">Add Funds</h2>
        <div class="form-group">
          <label class="form-label">Amount (‚Ç¶)</label>
          <input
            type="number"
            class="form-input"
            id="amountInput"
            placeholder="Enter amount"
            min="100"
          />
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button class="btn btn-secondary" id="cancelBtn" style="flex: 1">
            Cancel
          </button>
          <button class="btn btn-primary" id="payNowBtn" style="flex: 1">
            Pay Now
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Status Modal -->
    <div
      id="paymentStatusModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 16px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
          text-align: center;
        "
      >
        <h2 style="margin-bottom: 20px; margin-top: 0">üí≥ Payment Processing</h2>
        <p id="paymentStatusText" style="margin-bottom: 20px; color: #666;">
          Your payment is being processed. This may take a few moments...
        </p>
        <div id="paymentStatusSpinner" style="margin: 20px 0;">
          ‚è≥
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
          <button 
            class="btn btn-primary" 
            id="checkPaymentBtn" 
            style="flex: 1; min-width: 150px;"
          >
            üîç Check Payment Status
          </button>
          <button 
            class="btn btn-secondary" 
            id="closePaymentBtn" 
            style="flex: 1; min-width: 150px;"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/paystack-config.js"></script>
    <script src="../js/payment.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      // Wallet specific functionality
      let currentUser = null;

      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuth();
        
        // Hamburger menu toggle
        const hamburger = document.getElementById("hamburger");
        const sidebar = document.getElementById("sidebar");

        if (hamburger && sidebar) {
          // Toggle sidebar on hamburger click
          function toggleSidebar(e) {
            if (e) {
              e.stopPropagation();
              e.preventDefault();
            }
            hamburger.classList.toggle("active");
            sidebar.classList.toggle("active");
          }

          hamburger.addEventListener("click", toggleSidebar);
          hamburger.addEventListener("touchstart", toggleSidebar);

          // Close sidebar when clicking outside
          document.addEventListener(
            "click",
            (e) => {
              const isClickOnHamburger = hamburger.contains(e.target);
              const isClickOnSidebar = sidebar.contains(e.target);

              if (
                !isClickOnHamburger &&
                !isClickOnSidebar &&
                sidebar.classList.contains("active")
              ) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            },
            true
          );

          // Close sidebar when clicking a link on mobile
          document.querySelectorAll(".sidebar-link").forEach((link) => {
            link.addEventListener("click", () => {
              if (window.innerWidth <= 768) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            });
          });
        }
      });

      async function checkAuth() {
        return new Promise((resolve) => {
          try {
            // Use onAuthStateChange to properly wait for session restoration
            const { data: { subscription } } = supabase.auth.onAuthStateChange(
              async (event, session) => {
                console.log("Auth state changed:", event, session?.user?.id || "no user");
                
                if (session && session.user) {
                  currentUser = session.user;
                  console.log("User authenticated:", currentUser.email);
                  
                  // Load wallet data after auth is confirmed
                  await loadWalletData();
                  initWalletUI();
                  
                  // Cleanup subscription
                  subscription?.unsubscribe();
                  resolve(true);
                } else if (event === "INITIAL_SESSION") {
                  // No user on initial session check, redirect to auth
                  console.log("No authenticated user found");
                  window.location.href = "../auth.html";
                  resolve(false);
                }
              }
            );
          } catch (error) {
            console.error("Auth check error:", error);
            window.location.href = "../auth.html";
            resolve(false);
          }
        });
      }

      async function loadWalletData() {
        if (!currentUser) {
          console.error("No authenticated user");
          return;
        }

        try {
          console.log("Loading wallet data for user:", currentUser.id);

          // Get wallet data from Supabase
          let { data: wallet, error } = await supabase
            .from("wallets")
            .select("balance, total_added, total_spent")
            .eq("user_id", currentUser.id)
            .single();

          // If wallet doesn't exist, create it
          if (error && error.code === "PGRST116") {
            console.log("Wallet not found, creating new wallet...");
            const { data: newWallet, error: createError } = await supabase
              .from("wallets")
              .insert({
                user_id: currentUser.id,
                balance: 0.00,
                total_added: 0.00,
                total_spent: 0.00,
              })
              .select()
              .single();

            if (createError) {
              console.error("Error creating wallet:", createError);
              document.getElementById("walletBalance").textContent = "‚ùå Error loading wallet";
              return;
            }

            wallet = newWallet;
            console.log("New wallet created:", wallet);
          } else if (error) {
            console.error("Error loading wallet:", error);
            document.getElementById("walletBalance").textContent = "‚ùå Error loading wallet";
            return;
          }

          if (wallet) {
            console.log("Updating UI with wallet data:", wallet);
            const balance = parseFloat(wallet.balance || 0).toFixed(2);
            const totalAdded = parseFloat(wallet.total_added || 0).toFixed(2);
            const totalSpent = parseFloat(wallet.total_spent || 0).toFixed(2);

            document.getElementById("walletBalance").textContent = `‚Ç¶${balance}`;
            document.getElementById("balanceDisplay").textContent = `‚Ç¶${balance}`;
            document.getElementById("totalAdded").textContent = `‚Ç¶${totalAdded}`;
            document.getElementById("totalSpent").textContent = `‚Ç¶${totalSpent}`;
          } else {
            console.error("No wallet data returned");
            document.getElementById("walletBalance").textContent = "‚ùå No wallet data";
          }
        } catch (error) {
          console.error("Error loading wallet data:", error);
          document.getElementById("walletBalance").textContent = "‚ùå Error";
        }

        await loadTransactions();
      }

      async function loadTransactions() {
        try {
          if (!currentUser) return;

          console.log("Loading transactions for user:", currentUser.id);
          const { data: transactions, error } = await supabase
            .from("transactions")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false })
            .limit(50);

          if (error) {
            console.error("Error loading transactions:", error);
            return;
          }

          if (transactions && transactions.length > 0) {
            console.log("Found", transactions.length, "transactions");
            displayTransactions(transactions);
          }
        } catch (error) {
          console.error("Error in loadTransactions:", error);
        }
      }

      function displayTransactions(transactions) {
        const container = document.getElementById("transactionsContainer");
        container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions
                          .map(
                            (t) => `
                            <tr>
                                <td>${new Date(
                                  t.created_at
                                ).toLocaleDateString()}</td>
                                <td>${
                                  t.type === "credit" ? "‚ûï Credit" : "‚ûñ Debit"
                                }</td>
                                <td>${t.description || "N/A"}</td>
                                <td style="color: ${
                                  t.type === "credit" ? "#00d4aa" : "#ff4757"
                                }">
                                    ${
                                      t.type === "credit" ? "+" : "-"
                                    }‚Ç¶${t.amount.toFixed(2)}
                                </td>
                                <td><span class="status-badge status-${
                                  t.status
                                }">${t.status}</span></td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
      }

      function initWalletUI() {
        const addFundsBtn = document.getElementById("addFundsBtn");
        const modal = document.getElementById("addFundsModal");
        const cancelBtn = document.getElementById("cancelBtn");
        const payNowBtn = document.getElementById("payNowBtn");
        const applyPromoBtn = document.getElementById("applyPromoBtn");

        // Function to open modal
        function openModal() {
          console.log("Opening modal...");
          modal.style.display = "flex";
          modal.style.flexDirection = "column";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          document.body.style.overflow = "hidden"; // Prevent scrolling when modal is open
        }

        // Function to close modal
        function closeModal() {
          console.log("Closing modal...");
          modal.style.display = "none";
          document.body.style.overflow = "auto"; // Re-enable scrolling
        }

        // Open modal on button click
        addFundsBtn.addEventListener("click", openModal);

        // Close modal on cancel button click
        cancelBtn.addEventListener("click", closeModal);

        // Close modal when clicking on backdrop (outside the modal content)
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Close modal on Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.style.display === "flex") {
            closeModal();
          }
        });

        payNowBtn.addEventListener("click", async () => {
          const amount = parseInt(document.getElementById("amountInput").value);

          if (!amount || amount < 100) {
            alert("Minimum amount is ‚Ç¶100");
            return;
          }

          let paymentStarted = false;

          try {
            console.log("=== PAYMENT PROCESS STARTED ===");
            payNowBtn.disabled = true;
            payNowBtn.textContent = "Processing...";
            
            // Use currentUser which is already authenticated
            if (!currentUser) {
              throw new Error("User not authenticated. Please sign in again.");
            }

            console.log("‚úì Step 1: Current user verified:", currentUser.email, "Amount:", amount);

            const { data: profile } = await supabase
              .from("profiles")
              .select("email")
              .eq("id", currentUser.id)
              .single();

            if (!profile || !profile.email) {
              throw new Error("User profile not found");
            }

            console.log("‚úì Step 2: User profile found:", profile.email);

            // Initialize Paystack payment
            const paystack = new PaystackPayment();
            console.log("‚úì Step 3: Paystack initialized, opening payment modal...");
            
            paymentStarted = true;
            
            // Store the reference for manual checking
            const tempRef = "BDSMS_" + Math.random().toString(36).substring(2, 15) + Date.now();
            console.log("Payment reference:", tempRef);
            console.log("Starting payment verification process...");
            
            // Close the Add Funds modal and show payment status modal
            modal.style.display = "none";
            const paymentStatusModal = document.getElementById("paymentStatusModal");
            paymentStatusModal.style.display = "flex";
            paymentStatusModal.style.flexDirection = "column";
            paymentStatusModal.style.alignItems = "center";
            paymentStatusModal.style.justifyContent = "center";
            
            // Add check payment handler
            const checkPaymentBtn = document.getElementById("checkPaymentBtn");
            const closePaymentBtn = document.getElementById("closePaymentBtn");
            
            // Remove old listeners
            checkPaymentBtn.replaceWith(checkPaymentBtn.cloneNode(true));
            closePaymentBtn.replaceWith(closePaymentBtn.cloneNode(true));
            
            // Re-query after replacement
            const newCheckBtn = document.getElementById("checkPaymentBtn");
            const newCloseBtn = document.getElementById("closePaymentBtn");
            
            newCheckBtn.addEventListener("click", async () => {
              console.log("User clicked 'Check Payment Status'");
              newCheckBtn.disabled = true;
              newCheckBtn.textContent = "üîÑ Checking...";
              
              try {
                // Get the actual payment reference from database
                const { data: payments } = await supabase
                  .from("payment_history")
                  .select("reference, status")
                  .eq("user_id", currentUser.id)
                  .order("created_at", { ascending: false })
                  .limit(1);
                  
                if (payments && payments.length > 0) {
                  const payment = payments[0];
                  console.log("Found payment:", payment.reference, "Status:", payment.status);
                  
                  if (payment.status === "success") {
                    console.log("‚úÖ Payment is successful!");
                    document.getElementById("paymentStatusText").textContent = "‚úÖ Payment Confirmed! Updating your wallet...";
                    document.getElementById("paymentStatusSpinner").textContent = "‚úì";
                    
                    // Close status modal
                    paymentStatusModal.style.display = "none";
                    
                    // Reload wallet
                    await loadWalletData();
                    alert("‚úÖ Your wallet has been updated!");
                  } else if (payment.status === "pending") {
                    console.log("Payment still pending...");
                    document.getElementById("paymentStatusText").textContent = "‚è≥ Payment still processing. Please wait...";
                    newCheckBtn.disabled = false;
                    newCheckBtn.textContent = "üîç Check Again";
                  } else if (payment.status === "failed") {
                    console.log("Payment failed");
                    document.getElementById("paymentStatusText").textContent = "‚ùå Payment failed. Please try again.";
                    newCheckBtn.disabled = false;
                    newCheckBtn.textContent = "Try Again";
                  }
                } else {
                  console.log("No payment found");
                  document.getElementById("paymentStatusText").textContent = "‚ùå No payment found. Try again.";
                  newCheckBtn.disabled = false;
                  newCheckBtn.textContent = "üîç Check Again";
                }
              } catch (error) {
                console.error("Error checking payment:", error);
                document.getElementById("paymentStatusText").textContent = "‚ùå Error checking status";
                newCheckBtn.disabled = false;
                newCheckBtn.textContent = "Try Again";
              }
            });
            
            newCloseBtn.addEventListener("click", () => {
              paymentStatusModal.style.display = "none";
              document.body.style.overflow = "auto";
            });
            
            const result = await paystack.initializePayment(
              amount,
              profile.email,
              currentUser.id
            );
            
            console.log("‚úì Step 4: Payment completed, result:", result);

            if (!result) {
              throw new Error("No payment result returned");
            }

            console.log("‚úì Step 5: Payment verification successful");

            // Payment was successful - CLOSE MODAL COMPLETELY
            console.log("‚úì Step 6: Closing all modals and cleaning up UI...");
            
            // Close payment status modal
            paymentStatusModal.style.display = "none";
            
            // Force close any open Paystack modals/iframes
            if (typeof forceClosePaystackModal === 'function') {
              forceClosePaystackModal();
            }
            
            // Close the modal using proper display property
            modal.style.display = "none";
            
            // Re-enable body scrolling
            document.body.style.overflow = "auto";
            
            // Clear input field
            document.getElementById("amountInput").value = "";
            
            console.log("‚úì Step 7: Modal closed successfully");
            
            // Show success message with new balance
            alert(
              `‚úÖ Payment Successful!\n\nAmount: ‚Ç¶${amount.toFixed(2)}\nReference: ${result.reference}\n\nUpdating your wallet...`
            );
            
            console.log("‚úì Step 8: Success alerts shown, reloading wallet data...");
            
            // Add small delay to ensure database is updated
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Reload wallet data to show updated balance
            await loadWalletData();
            
            console.log("‚úì Step 9: Wallet data reloaded");
            
            alert("‚úÖ Your wallet has been updated!");
            
            console.log("=== PAYMENT PROCESS COMPLETED SUCCESSFULLY ===");
            
          } catch (error) {
            console.error("‚ùå PAYMENT ERROR:", error);
            console.error("Error message:", error.message);
            console.error("Error stack:", error.stack);
            
            // Force close any Paystack modals
            if (typeof forceClosePaystackModal === 'function') {
              forceClosePaystackModal();
            }
            
            // Always close modal on error too
            modal.style.display = "none";
            document.body.style.overflow = "auto";
            
            if (paymentStarted) {
              alert("Payment was initiated but verification failed. Your wallet may still be updated. Check your transaction history.");
            } else {
              alert("‚ùå Payment error: " + error.message + "\n\nPlease check the browser console (F12) for more details.");
            }
          } finally {
            payNowBtn.disabled = false;
            payNowBtn.textContent = "Pay Now";
          }
        });

        applyPromoBtn.addEventListener("click", async () => {
          const code = document.getElementById("promoCodeInput").value.trim();
          if (!code) return;

          const result = await DB.applyPromoCode(currentUser.id, code);
          const message = document.getElementById("promoMessage");
          message.style.display = "block";

          if (result.success) {
            message.style.color = "#00d4aa";
            message.textContent = `‚úÖ Promo code applied! You'll get ${
              result.data.discount_value
            }${
              result.data.discount_type === "percentage" ? "%" : "‚Ç¶"
            } off your next purchase.`;
          } else {
            message.style.color = "#ff4757";
            message.textContent = `‚ùå ${result.error}`;
          }
        });
      }
    </script>
    <script src="../js/chatbot.js"></script>
  </body>
</html>
