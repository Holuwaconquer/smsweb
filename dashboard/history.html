<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction History - Femzy</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        text-align: center;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #00d4aa;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #999;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
      }

      .filters-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        margin-bottom: 30px;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
      }

      .form-input,
      .form-select {
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .table-container {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow-x: auto;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f8f9fa;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
        color: #333;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-credit {
        background: #e0f7f4;
        color: #00d4aa;
      }

      .status-debit {
        background: #ffebee;
        color: #ff4757;
      }

      .status-completed {
        background: #e3f2fd;
        color: #2196f3;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .btn-page {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-page:hover {
        background: #f8f9fa;
      }

      .btn-page.active {
        background: #00d4aa;
        color: white;
        border-color: #00d4aa;
      }

      .btn-export {
        background: linear-gradient(135deg, #00d4aa, #00b894);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 212, 170, 0.3);
      }

      .balance-warning {
        background: #fff3e0;
        border: 1px solid #ffb74d;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        color: #e65100;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .stats-row {
          grid-template-columns: 1fr;
        }

        .filter-grid {
          grid-template-columns: 1fr;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="logo">
          <div class="logo-icon">F</div>
          Femzy
        </div>
      </div>
      <div class="nav-right">
        <div class="balance-badge" id="balanceDisplay">‚Ç¶0.00</div>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <a href="index.html" class="sidebar-link">üìä Dashboard</a>
        <a href="usa-numbers.html" class="sidebar-link">üá∫üá∏ Buy USA Numbers</a>
        <a href="all-countries.html" class="sidebar-link"
          >üåç International Numbers</a
        >
        <a href="logs.html" class="sidebar-link">üìù Buy Logs</a>
        <a href="booster.html" class="sidebar-link">üìà Social Booster</a>
        <a href="inbox.html" class="sidebar-link">üì¨ SMS Inbox</a>
        <a href="history.html" class="sidebar-link active">üìã History</a>
      </div>
      <div class="sidebar-section">
        <a href="wallet.html" class="sidebar-link">üí∞ Wallet</a>
        <a href="profile.html" class="sidebar-link">üë§ Profile</a>
      </div>
      <div class="sidebar-section" id="adminSection" style="display: none">
        <a
          href="../admin/index.html"
          class="sidebar-link"
          style="
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border-radius: 8px;
          "
          >‚öôÔ∏è Admin Panel</a
        >
      </div>
      <div class="sidebar-section" style="margin-top: auto">
        <button
          id="logoutBtn"
          class="btn btn-danger"
          style="width: 100%; padding: 12px; cursor: pointer"
        >
          üö™ Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>Transaction History</h1>
        <p>View and manage all your transactions</p>
      </div>

      <div
        id="balanceWarning"
        class="balance-warning"
        style="display: none"
      ></div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-value" id="totalSpent">‚Ç¶0.00</div>
          <div class="stat-label">Total Spent</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalCredit">‚Ç¶0.00</div>
          <div class="stat-label">Total Credited</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalTransactions">0</div>
          <div class="stat-label">Total Transactions</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filter-grid">
          <div class="form-group">
            <label class="form-label">Transaction Type</label>
            <select
              id="typeFilter"
              class="form-select"
              onchange="filterTransactions()"
            >
              <option value="">All Types</option>
              <option value="debit">Debit (Spent)</option>
              <option value="credit">Credit (Received)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Search Description</label>
            <input
              type="text"
              id="searchFilter"
              class="form-input"
              placeholder="Search..."
              onkeyup="filterTransactions()"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Date Range</label>
            <select
              id="dateFilter"
              class="form-select"
              onchange="filterTransactions()"
            >
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
          <div class="form-group">
            <button class="btn-export" onclick="exportCSV()">
              üì• Export CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Transactions Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="transactionsBody">
            <tr>
              <td
                colspan="5"
                style="text-align: center; padding: 40px; color: #999"
              >
                Loading transactions...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      let currentUser = null;
      let allTransactions = [];
      let currentPage = 1;
      const transactionsPerPage = 15;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!(await checkAuth())) {
          window.location.href = "../auth.html";
          return;
        }
        const { user } = await getCurrentUser();
        currentUser = user;
        loadBalance();
        loadTransactions();

        // Check if user is admin and show admin button
        const isAdmin = await isUserAdmin(user.id);
        if (isAdmin) {
          document.getElementById("adminSection").style.display = "block";
        }

        // Hamburger menu toggle
        const hamburger = document.getElementById("hamburger");
        const sidebar = document.querySelector(".sidebar");

        if (hamburger && sidebar) {
          // Toggle sidebar on hamburger click
          function toggleSidebar(e) {
            if (e) {
              e.stopPropagation();
              e.preventDefault();
            }
            hamburger.classList.toggle("active");
            sidebar.classList.toggle("active");
          }

          hamburger.addEventListener("click", toggleSidebar);
          hamburger.addEventListener("touchstart", toggleSidebar);

          // Close sidebar when clicking outside
          document.addEventListener(
            "click",
            (e) => {
              const isClickOnHamburger = hamburger.contains(e.target);
              const isClickOnSidebar = sidebar.contains(e.target);

              if (
                !isClickOnHamburger &&
                !isClickOnSidebar &&
                sidebar.classList.contains("active")
              ) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            },
            true
          );

          // Close sidebar when clicking a link on mobile
          document.querySelectorAll(".sidebar-link").forEach((link) => {
            link.addEventListener("click", () => {
              if (window.innerWidth <= 768) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            });
          });
        }

        // Logout button handler
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            const success = await signOut();
            if (success) {
              window.location.href = "../auth.html";
            } else {
              alert("Logout failed. Please try again.");
            }
          });
        }
      });

      async function loadTransactions() {
        try {
          allTransactions = await getTransactions(currentUser.id);
          updateStats();
          displayTransactions();
        } catch (error) {
          console.error("Error loading transactions:", error);
        }
      }

      function updateStats() {
        let totalSpent = 0;
        let totalCredit = 0;

        allTransactions.forEach((tx) => {
          if (tx.type === "debit") {
            totalSpent += tx.amount;
          } else {
            totalCredit += tx.amount;
          }
        });

        document.getElementById(
          "totalSpent"
        ).textContent = `‚Ç¶${totalSpent.toFixed(2)}`;
        document.getElementById(
          "totalCredit"
        ).textContent = `‚Ç¶${totalCredit.toFixed(2)}`;
        document.getElementById("totalTransactions").textContent =
          allTransactions.length;
      }

      function filterTransactions() {
        const typeFilter = document.getElementById("typeFilter").value;
        const searchFilter = document
          .getElementById("searchFilter")
          .value.toLowerCase();
        const dateFilter = document.getElementById("dateFilter").value;

        let filtered = allTransactions.filter((tx) => {
          if (typeFilter && tx.type !== typeFilter) return false;
          if (
            searchFilter &&
            !tx.description.toLowerCase().includes(searchFilter)
          )
            return false;

          if (dateFilter) {
            const txDate = new Date(tx.created_at);
            const today = new Date();
            const diffTime = Math.abs(today - txDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (dateFilter === "today" && diffDays > 1) return false;
            if (dateFilter === "week" && diffDays > 7) return false;
            if (dateFilter === "month" && diffDays > 30) return false;
          }

          return true;
        });

        allTransactions = filtered;
        currentPage = 1;
        displayTransactions();
      }

      function displayTransactions() {
        const start = (currentPage - 1) * transactionsPerPage;
        const end = start + transactionsPerPage;
        const pageTransactions = allTransactions.slice(start, end);
        const tbody = document.getElementById("transactionsBody");

        tbody.innerHTML = "";

        if (pageTransactions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No transactions found</td></tr>';
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        pageTransactions.forEach((tx) => {
          const row = tbody.insertRow();
          row.innerHTML = `
                    <td>${new Date(tx.created_at).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${tx.type}">${
            tx.type === "debit" ? "‚Üì Debit" : "‚Üë Credit"
          }</span></td>
                    <td>${tx.description}</td>
                    <td style="color: ${
                      tx.type === "debit" ? "#ff4757" : "#00d4aa"
                    }; font-weight: 600;">
                        ${tx.type === "debit" ? "-" : "+"}‚Ç¶${tx.amount.toFixed(
            2
          )}
                    </td>
                    <td><span class="status-badge status-completed">Completed</span></td>
                `;
        });

        renderPagination();
      }

      function renderPagination() {
        const totalPages = Math.ceil(
          allTransactions.length / transactionsPerPage
        );
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.className = `btn-page ${i === currentPage ? "active" : ""}`;
          btn.textContent = i;
          btn.onclick = () => {
            currentPage = i;
            displayTransactions();
          };
          pagination.appendChild(btn);
        }
      }

      function exportCSV() {
        if (allTransactions.length === 0) {
          alert("No transactions to export");
          return;
        }

        let csv = "Date,Type,Description,Amount,Status\n";
        allTransactions.forEach((tx) => {
          csv += `${new Date(tx.created_at).toLocaleDateString()},"${
            tx.type
          }","${tx.description}",${tx.amount},"Completed"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "transactions.csv";
        a.click();
      }

      async function loadBalance() {
        try {
          const wallet = await getWallet(currentUser.id);
          document.getElementById(
            "balanceDisplay"
          ).textContent = `‚Ç¶${wallet.balance.toFixed(2)}`;
        } catch (error) {
          console.error("Error loading balance:", error);
        }
      }
    </script>
  </body>
</html>
