<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMS Inbox - BasedSMS</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .inbox-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 20px;
        min-height: 600px;
      }

      @media (max-width: 768px) {
        .inbox-container {
          grid-template-columns: 1fr;
        }
      }

      .numbers-list {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .numbers-list h3 {
        padding: 20px;
        margin: 0;
        background: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
        color: #333;
        font-size: 16px;
      }

      .numbers-scroll {
        flex: 1;
        overflow-y: auto;
        max-height: 600px;
      }

      .number-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .number-item:hover {
        background: #f9f9f9;
      }

      .number-item.active {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding-left: 16px;
      }

      .number-info {
        flex: 1;
      }

      .number-text {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }

      .number-meta {
        font-size: 12px;
        color: #999;
      }

      .unread-badge {
        background: #f44336;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
      }

      .empty-numbers {
        padding: 40px 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
      }

      .messages-panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .panel-header {
        background: #f5f5f5;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-info h2 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 20px;
      }

      .header-info p {
        margin: 0;
        color: #999;
        font-size: 12px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .btn-refresh {
        background: #2196f3;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.3s;
      }

      .btn-refresh:hover {
        background: #1976d2;
      }

      .btn-delete {
        background: #f44336;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.3s;
      }

      .btn-delete:hover {
        background: #d32f2f;
      }

      .messages-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .message {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }

      .message-sender {
        font-weight: 700;
        color: #333;
      }

      .message-time {
        font-size: 12px;
        color: #999;
      }

      .message-content {
        color: #555;
        line-height: 1.6;
        word-break: break-word;
        font-size: 14px;
      }

      .message-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e0e0e0;
      }

      .btn-copy-msg {
        background: #2196f3;
        color: white;
        padding: 4px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.3s;
      }

      .btn-copy-msg:hover {
        background: #1976d2;
      }

      .empty-state {
        padding: 60px 20px;
        text-align: center;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2196f3;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 30px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .auto-refresh-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #666;
      }

      .toggle-switch {
        width: 40px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #4caf50;
      }

      .toggle-knob {
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
      }

      .toggle-switch.active .toggle-knob {
        left: 18px;
      }

      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #1565c0;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">BasedSMS</div>
        <nav class="nav-menu">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="usa-numbers.html" class="nav-link">Buy USA Numbers</a>
          <a href="all-countries.html" class="nav-link"
            >International Numbers</a
          >
          <a href="logs.html" class="nav-link">Buy Logs</a>
          <a href="booster.html" class="nav-link">Social Booster</a>
          <a href="inbox.html" class="nav-link active">SMS Inbox</a>
          <a href="history.html" class="nav-link">History</a>
          <a href="wallet.html" class="nav-link">Wallet</a>
          <a href="profile.html" class="nav-link">Profile</a>
        </nav>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="header-right">
            <div class="balance-display">
              Balance: <strong id="balanceDisplay">â‚¦0.00</strong>
            </div>
            <div class="user-menu">
              <span id="username">User</span>
            </div>
          </div>
        </header>

        <div class="content">
          <h1>SMS Inbox</h1>
          <p>View SMS messages received on your numbers</p>

          <div class="info-box">
            ðŸ’¡ Messages are automatically synced. Use the refresh button to
            fetch latest messages manually.
          </div>

          <div class="inbox-container">
            <!-- Numbers List -->
            <div class="numbers-list">
              <h3>Your Numbers</h3>
              <div class="numbers-scroll" id="numbersList"></div>
            </div>

            <!-- Messages Panel -->
            <div class="messages-panel">
              <div class="panel-header">
                <div class="header-info">
                  <h2 id="selectedNumberDisplay">Select a number</h2>
                  <p id="selectedNumberMeta"></p>
                </div>
                <div class="header-actions">
                  <div class="auto-refresh-toggle">
                    <span>Auto-refresh</span>
                    <div
                      class="toggle-switch"
                      id="autoRefreshToggle"
                      onclick="toggleAutoRefresh()"
                    >
                      <div class="toggle-knob"></div>
                    </div>
                  </div>
                  <button class="btn-refresh" onclick="refreshMessages()">
                    Refresh
                  </button>
                  <button
                    class="btn-delete"
                    id="deleteNumberBtn"
                    onclick="deleteSelectedNumber()"
                    style="display: none"
                  >
                    Delete
                  </button>
                </div>
              </div>
              <div class="messages-scroll" id="messagesContainer">
                <div class="empty-state">
                  <div class="empty-state-icon">ðŸ“±</div>
                  <p>Select a number from the list to view messages</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivjs.org/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      let currentUser = null;
      let selectedNumber = null;
      let autoRefreshEnabled = false;
      let autoRefreshInterval = null;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!(await checkAuth())) return;
        const { user } = await getCurrentUser();
        currentUser = user;
        document.getElementById("username").textContent =
          user.email.split("@")[0];
        loadBalance();
        loadNumbers();
      });

      async function loadNumbers() {
        try {
          const numbers = await getSMSNumbers(currentUser.id);
          const container = document.getElementById("numbersList");

          if (numbers.length === 0) {
            container.innerHTML =
              '<div class="empty-numbers">No numbers to monitor. Buy a number first!</div>';
            return;
          }

          let html = "";
          numbers.forEach((num, index) => {
            const unreadCount = Math.floor(Math.random() * 5); // Mock unread count
            html += `
                        <div class="number-item ${
                          index === 0 ? "active" : ""
                        }" onclick="selectNumber('${num.id}', '${
              num.phone_number
            }', '${num.service}', '${num.country}')">
                            <div class="number-info">
                                <div class="number-text">${
                                  num.phone_number
                                }</div>
                                <div class="number-meta">${num.service.toUpperCase()} â€¢ ${
              num.country
            }</div>
                            </div>
                            ${
                              unreadCount > 0
                                ? `<div class="unread-badge">${unreadCount}</div>`
                                : ""
                            }
                        </div>
                    `;
          });

          container.innerHTML = html;

          // Auto-select first number
          selectNumber(
            numbers[0].id,
            numbers[0].phone_number,
            numbers[0].service,
            numbers[0].country
          );
        } catch (error) {
          console.error("Error loading numbers:", error);
        }
      }

      function selectNumber(numberId, phoneNumber, service, country) {
        selectedNumber = { id: numberId, phone: phoneNumber, service, country };

        // Update active state
        document.querySelectorAll(".number-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        // Update header
        document.getElementById("selectedNumberDisplay").textContent =
          phoneNumber;
        document.getElementById(
          "selectedNumberMeta"
        ).textContent = `${service.toUpperCase()} â€¢ ${country}`;
        document.getElementById("deleteNumberBtn").style.display = "block";

        loadMessages();
      }

      async function loadMessages() {
        try {
          const container = document.getElementById("messagesContainer");
          container.innerHTML = '<div class="spinner"></div>';

          // Simulate API call
          await new Promise((resolve) => setTimeout(resolve, 500));

          const messages = generateMockMessages();

          if (messages.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“­</div>
                            <p>No messages yet for this number</p>
                        </div>
                    `;
            return;
          }

          let html = "";
          messages.forEach((msg) => {
            const time = new Date(msg.time).toLocaleString();
            html += `
                        <div class="message">
                            <div class="message-header">
                                <div class="message-sender">${msg.sender}</div>
                                <div class="message-time">${time}</div>
                            </div>
                            <div class="message-content">${msg.content}</div>
                            <div class="message-actions">
                                <button class="btn-copy-msg" onclick="copyMessage('${msg.content.replace(
                                  /'/g,
                                  "\\'"
                                )}')">Copy</button>
                            </div>
                        </div>
                    `;
          });

          container.innerHTML = html;
        } catch (error) {
          console.error("Error loading messages:", error);
        }
      }

      function generateMockMessages() {
        const senders = [
          "WhatsApp",
          "Google",
          "Facebook",
          "Instagram",
          "Telegram",
          "Twitter",
          "Amazon",
          "Bank Alert",
        ];

        const codes = [
          "Your WhatsApp code: 123456",
          "Google verification code: 654321",
          "Facebook login code: 789456",
          "Instagram verification: 456789",
          "Telegram login code: 321654",
          "Your 2FA code is: 987654",
          "Password reset code: 555666",
          "Account confirmation: 333444",
        ];

        const count = Math.floor(Math.random() * 8) + 1;
        const messages = [];

        for (let i = 0; i < count; i++) {
          messages.push({
            sender: senders[Math.floor(Math.random() * senders.length)],
            content: codes[Math.floor(Math.random() * codes.length)],
            time: new Date(Date.now() - Math.random() * 3600000),
          });
        }

        return messages.sort((a, b) => b.time - a.time);
      }

      async function refreshMessages() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = "Refreshing...";

        await loadMessages();

        btn.disabled = false;
        btn.textContent = "Refresh";
      }

      function toggleAutoRefresh() {
        const toggle = document.getElementById("autoRefreshToggle");
        autoRefreshEnabled = !autoRefreshEnabled;
        toggle.classList.toggle("active");

        if (autoRefreshEnabled) {
          autoRefreshInterval = setInterval(loadMessages, 5000);
          showSuccess("Auto-refresh enabled (every 5 seconds)");
        } else {
          clearInterval(autoRefreshInterval);
          showSuccess("Auto-refresh disabled");
        }
      }

      function copyMessage(content) {
        navigator.clipboard.writeText(content);
        showSuccess("Message copied to clipboard");
      }

      async function deleteSelectedNumber() {
        if (
          !selectedNumber ||
          !confirm("Delete this number? This action cannot be undone.")
        )
          return;

        try {
          await deleteSMSNumber(selectedNumber.id);
          showSuccess("Number deleted");
          selectedNumber = null;
          document.getElementById("deleteNumberBtn").style.display = "none";
          loadNumbers();
        } catch (error) {
          console.error("Delete error:", error);
          showError("Failed to delete number");
        }
      }

      async function loadBalance() {
        try {
          const wallet = await getWallet(currentUser.id);
          document.getElementById(
            "balanceDisplay"
          ).textContent = `â‚¦${wallet.balance.toFixed(2)}`;
        } catch (error) {
          console.error("Error loading balance:", error);
        }
      }

      function showSuccess(msg) {
        alert("âœ“ " + msg);
      }

      function showError(msg) {
        alert("âœ— " + msg);
      }

      document.getElementById("hamburger").addEventListener("click", () => {
        document.getElementById("hamburger").classList.toggle("active");
        document.querySelector(".sidebar").classList.toggle("active");
      });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          clearInterval(autoRefreshInterval);
          await signOut();
          window.location.href = "../auth.html";
        });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        clearInterval(autoRefreshInterval);
      });
    </script>
  </body>
</html>
