<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buy USA Numbers - BasedSMS</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .numbers-container {
        display: grid;
        gap: 20px;
      }

      .service-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
      }

      .service-name {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .service-price {
        background: #e8f5e9;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 600;
        color: #4caf50;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .btn-search {
        background: #2196f3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
      }

      .btn-search:hover {
        background: #1976d2;
      }

      .numbers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .number-card {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
        cursor: pointer;
      }

      .number-card:hover {
        border-color: #2196f3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
      }

      .number-text {
        font-size: 18px;
        font-weight: bold;
        color: #2196f3;
        margin-bottom: 10px;
      }

      .number-status {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
      }

      .btn-buy {
        background: #4caf50;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        width: 100%;
        transition: background 0.3s;
      }

      .btn-buy:hover {
        background: #45a049;
      }

      .active-numbers {
        margin-top: 30px;
      }

      .active-numbers h3 {
        font-size: 20px;
        margin-bottom: 15px;
        color: #333;
      }

      .number-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .number-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
      }

      .number-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-expired {
        background: #ffebee;
        color: #c62828;
      }

      .btn-copy {
        background: #2196f3;
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .btn-delete {
        background: #f44336;
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 5px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .loader {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loader.active {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2196f3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .balance-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">BasedSMS</div>
        <nav class="nav-menu">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="usa-numbers.html" class="nav-link active">Buy USA Numbers</a>
          <a href="all-countries.html" class="nav-link"
            >International Numbers</a
          >
          <a href="logs.html" class="nav-link">Buy Logs</a>
          <a href="booster.html" class="nav-link">Social Booster</a>
          <a href="inbox.html" class="nav-link">SMS Inbox</a>
          <a href="history.html" class="nav-link">History</a>
          <a href="wallet.html" class="nav-link">Wallet</a>
          <a href="profile.html" class="nav-link">Profile</a>
        </nav>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="header-right">
            <div class="balance-display">
              Balance: <strong id="balanceDisplay">₦0.00</strong>
            </div>
            <div class="user-menu">
              <span id="username">User</span>
            </div>
          </div>
        </header>

        <div class="content">
          <h1>Buy USA Phone Numbers</h1>
          <p>Purchase USA phone numbers for SMS verification services</p>

          <div
            id="balanceWarning"
            class="balance-warning"
            style="display: none"
          ></div>

          <div class="numbers-container">
            <!-- WhatsApp Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">WhatsApp</span>
                <span class="service-price" data-price="200">₦200</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('whatsapp')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-whatsapp">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-whatsapp"></div>
              <div class="active-numbers">
                <h3>Your WhatsApp Numbers</h3>
                <div id="active-whatsapp"></div>
              </div>
            </div>

            <!-- Telegram Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">Telegram</span>
                <span class="service-price" data-price="150">₦150</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('telegram')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-telegram">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-telegram"></div>
              <div class="active-numbers">
                <h3>Your Telegram Numbers</h3>
                <div id="active-telegram"></div>
              </div>
            </div>

            <!-- Instagram Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">Instagram</span>
                <span class="service-price" data-price="180">₦180</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('instagram')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-instagram">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-instagram"></div>
              <div class="active-numbers">
                <h3>Your Instagram Numbers</h3>
                <div id="active-instagram"></div>
              </div>
            </div>

            <!-- Facebook Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">Facebook</span>
                <span class="service-price" data-price="170">₦170</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('facebook')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-facebook">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-facebook"></div>
              <div class="active-numbers">
                <h3>Your Facebook Numbers</h3>
                <div id="active-facebook"></div>
              </div>
            </div>

            <!-- Twitter Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">Twitter</span>
                <span class="service-price" data-price="160">₦160</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('twitter')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-twitter">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-twitter"></div>
              <div class="active-numbers">
                <h3>Your Twitter Numbers</h3>
                <div id="active-twitter"></div>
              </div>
            </div>

            <!-- Google Service -->
            <div class="service-section">
              <div class="service-header">
                <span class="service-name">Google</span>
                <span class="service-price" data-price="190">₦190</span>
              </div>
              <div class="controls">
                <button class="btn-search" onclick="searchNumbers('google')">
                  Search Available Numbers
                </button>
              </div>
              <div class="loader" id="loader-google">
                <div class="spinner"></div>
              </div>
              <div class="numbers-grid" id="numbers-google"></div>
              <div class="active-numbers">
                <h3>Your Google Numbers</h3>
                <div id="active-google"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      let currentUser = null;
      const services = [
        "whatsapp",
        "telegram",
        "instagram",
        "facebook",
        "twitter",
        "google",
      ];
      const prices = {
        whatsapp: 200,
        telegram: 150,
        instagram: 180,
        facebook: 170,
        twitter: 160,
        google: 190,
      };

      document.addEventListener("DOMContentLoaded", async () => {
        if (!(await checkAuth())) return;
        const { user } = await getCurrentUser();
        currentUser = user;
        document.getElementById("username").textContent =
          user.email.split("@")[0];
        loadBalance();
        loadActiveNumbers();
      });

      async function searchNumbers(service) {
        const loader = document.getElementById(`loader-${service}`);
        const container = document.getElementById(`numbers-${service}`);

        loader.classList.add("active");
        container.innerHTML = "";

        // Simulate API call delay
        await new Promise((resolve) => setTimeout(resolve, 500));

        const mockNumbers = generateMockNumbers(5);
        const price = prices[service];

        mockNumbers.forEach((number) => {
          const card = document.createElement("div");
          card.className = "number-card";
          card.innerHTML = `
                    <div class="number-text">${number}</div>
                    <div class="number-status">USA - ${service.toUpperCase()}</div>
                    <button class="btn-buy" onclick="buyNumber('${number}', '${service}', ${price})">
                        Buy ₦${price}
                    </button>
                `;
          container.appendChild(card);
        });

        loader.classList.remove("active");
      }

      function generateMockNumbers(count) {
        const numbers = [];
        for (let i = 0; i < count; i++) {
          const num =
            "+1" + Math.floor(Math.random() * 9000000000 + 1000000000);
          numbers.push(num);
        }
        return numbers;
      }

      async function buyNumber(phoneNumber, service, price) {
        const wallet = await getWallet(currentUser.id);

        if (wallet.balance < price) {
          showWarning(
            `Insufficient balance. You need ₦${price} but have ₦${wallet.balance}`
          );
          return;
        }

        try {
          // Deduct from wallet
          await updateWallet(currentUser.id, wallet.balance - price);

          // Create transaction
          await createTransaction(
            currentUser.id,
            "debit",
            price,
            `Purchased ${service} number: ${phoneNumber}`,
            "sms_number_purchase"
          );

          // Add SMS number
          await addSMSNumber(
            currentUser.id,
            phoneNumber,
            "United States",
            "US",
            service,
            price
          );

          showSuccess(`Number purchased successfully! ${phoneNumber}`);
          loadBalance();
          loadActiveNumbers();
        } catch (error) {
          console.error("Purchase error:", error);
          showError("Purchase failed. Please try again.");
        }
      }

      async function loadActiveNumbers() {
        try {
          const numbers = await getSMSNumbers(currentUser.id);

          services.forEach((service) => {
            const container = document.getElementById(`active-${service}`);
            const serviceNumbers = numbers.filter((n) => n.service === service);

            if (serviceNumbers.length === 0) {
              container.innerHTML =
                '<div class="empty-state">No active numbers</div>';
              return;
            }

            let html =
              '<table class="number-table"><thead><tr><th>Number</th><th>Status</th><th>Expires</th><th>Actions</th></tr></thead><tbody>';

            serviceNumbers.forEach((num) => {
              const status =
                new Date(num.expires_at) > new Date() ? "active" : "expired";
              html += `
                            <tr>
                                <td>${num.phone_number}</td>
                                <td><span class="status-badge status-${status}">${status}</span></td>
                                <td>${new Date(
                                  num.expires_at
                                ).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn-copy" onclick="copyToClipboard('${
                                      num.phone_number
                                    }')">Copy</button>
                                    <button class="btn-delete" onclick="deleteNumber('${
                                      num.id
                                    }')">Delete</button>
                                </td>
                            </tr>
                        `;
            });

            html += "</tbody></table>";
            container.innerHTML = html;
          });
        } catch (error) {
          console.error("Error loading active numbers:", error);
        }
      }

      async function deleteNumber(numberId) {
        if (!confirm("Are you sure you want to delete this number?")) return;

        try {
          await deleteSMSNumber(numberId);
          showSuccess("Number deleted successfully");
          loadActiveNumbers();
        } catch (error) {
          console.error("Delete error:", error);
          showError("Failed to delete number");
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          showSuccess("Number copied to clipboard");
        });
      }

      async function loadBalance() {
        try {
          const wallet = await getWallet(currentUser.id);
          document.getElementById(
            "balanceDisplay"
          ).textContent = `₦${wallet.balance.toFixed(2)}`;

          if (wallet.balance < 100) {
            document.getElementById("balanceWarning").style.display = "block";
            document.getElementById("balanceWarning").textContent =
              "⚠️ Low balance. Top up your wallet to continue purchasing.";
          }
        } catch (error) {
          console.error("Error loading balance:", error);
        }
      }

      function showSuccess(msg) {
        alert("✓ " + msg);
      }

      function showError(msg) {
        alert("✗ " + msg);
      }

      function showWarning(msg) {
        alert("⚠️ " + msg);
      }

      // Hamburger menu toggle
      document.getElementById("hamburger").addEventListener("click", () => {
        document.getElementById("hamburger").classList.toggle("active");
        document.querySelector(".sidebar").classList.toggle("active");
      });

      // Logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          await signOut();
          window.location.href = "../auth.html";
        });
    </script>
  </body>
</html>
