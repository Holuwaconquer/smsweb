<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>International Numbers - Femzy</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .filter-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        margin-bottom: 30px;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
      }

      .form-input,
      .form-select {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #00d4aa;
        box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
      }

      .countries-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .country-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
      }

      .country-card:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
      }

      .country-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }

      .country-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .country-flag {
        font-size: 28px;
      }

      .numbers-list {
        margin-bottom: 15px;
      }

      .number-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .number-info {
        display: flex;
        flex-direction: column;
      }

      .number-phone {
        font-weight: 600;
        color: #333;
        font-family: "Courier New", monospace;
      }

      .number-price {
        color: #00d4aa;
        font-weight: 600;
        margin-top: 4px;
      }

      .btn-buy {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #00d4aa, #00b894);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-buy:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 212, 170, 0.3);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .balance-warning {
        background: #fff3e0;
        border: 1px solid #ffb74d;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        color: #e65100;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .countries-grid {
          grid-template-columns: 1fr;
        }

        .filter-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="logo">
          <div class="logo-icon">B</div>
          Femzy
        </div>
      </div>
      <div class="nav-right">
        <div class="balance-badge" id="balanceDisplay">â‚¦0.00</div>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <a href="index.html" class="sidebar-link">ğŸ“Š Dashboard</a>
        <a href="usa-numbers.html" class="sidebar-link">ğŸ‡ºğŸ‡¸ Buy USA Numbers</a>
        <a href="all-countries.html" class="sidebar-link active"
          >ğŸŒ International Numbers</a
        >
        <a href="logs.html" class="sidebar-link">ğŸ“ Buy Logs</a>
        <a href="booster.html" class="sidebar-link">ğŸ“ˆ Social Booster</a>
        <a href="inbox.html" class="sidebar-link">ğŸ“¬ SMS Inbox</a>
        <a href="history.html" class="sidebar-link">ğŸ“‹ History</a>
      </div>
      <div class="sidebar-section">
        <a href="wallet.html" class="sidebar-link">ğŸ’° Wallet</a>
        <a href="profile.html" class="sidebar-link">ğŸ‘¤ Profile</a>
      </div>
      <div class="sidebar-section" id="adminSection" style="display: none">
        <a
          href="../admin/index.html"
          class="sidebar-link"
          style="
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border-radius: 8px;
          "
          >âš™ï¸ Admin Panel</a
        >
      </div>
      <div class="sidebar-section" style="margin-top: auto">
        <button
          id="logoutBtn"
          class="btn btn-danger"
          style="width: 100%; padding: 12px; cursor: pointer"
        >
          ğŸšª Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1>International Phone Numbers</h1>
        <p>Purchase phone numbers from 50+ countries for SMS verification</p>
      </div>

      <div
        id="balanceWarning"
        class="balance-warning"
        style="display: none"
      ></div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="filter-grid">
          <div class="form-group">
            <label class="form-label">Select Country</label>
            <select
              id="countryFilter"
              class="form-select"
              onchange="filterCountries()"
            >
              <option value="">All Countries</option>
              <option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option>
              <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
              <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
              <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
              <option value="France">ğŸ‡«ğŸ‡· France</option>
              <option value="India">ğŸ‡®ğŸ‡³ India</option>
              <option value="Brazil">ğŸ‡§ğŸ‡· Brazil</option>
              <option value="Mexico">ğŸ‡²ğŸ‡½ Mexico</option>
              <option value="Japan">ğŸ‡¯ğŸ‡µ Japan</option>
              <option value="Nigeria">ğŸ‡³ğŸ‡¬ Nigeria</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Price Range</label>
            <select
              id="priceFilter"
              class="form-select"
              onchange="filterByPrice()"
            >
              <option value="">All Prices</option>
              <option value="low">Under â‚¦200</option>
              <option value="medium">â‚¦200 - â‚¦500</option>
              <option value="high">Over â‚¦500</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Countries Grid -->
      <div class="countries-grid" id="countriesGrid"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      let currentUser = null;
      const countriesData = [
        {
          name: "United Kingdom",
          flag: "ğŸ‡¬ğŸ‡§",
          code: "GB",
          prices: [220, 250, 280],
        },
        { name: "Canada", flag: "ğŸ‡¨ğŸ‡¦", code: "CA", prices: [210, 240, 270] },
        { name: "Australia", flag: "ğŸ‡¦ğŸ‡º", code: "AU", prices: [230, 260, 290] },
        { name: "Germany", flag: "ğŸ‡©ğŸ‡ª", code: "DE", prices: [200, 230, 260] },
        { name: "France", flag: "ğŸ‡«ğŸ‡·", code: "FR", prices: [205, 235, 265] },
        { name: "India", flag: "ğŸ‡®ğŸ‡³", code: "IN", prices: [100, 120, 140] },
        { name: "Brazil", flag: "ğŸ‡§ğŸ‡·", code: "BR", prices: [150, 170, 190] },
        { name: "Mexico", flag: "ğŸ‡²ğŸ‡½", code: "MX", prices: [130, 150, 170] },
        { name: "Japan", flag: "ğŸ‡¯ğŸ‡µ", code: "JP", prices: [240, 270, 300] },
        { name: "Nigeria", flag: "ğŸ‡³ğŸ‡¬", code: "NG", prices: [80, 100, 120] },
      ];

      document.addEventListener("DOMContentLoaded", async () => {
        if (!(await checkAuth())) {
          window.location.href = "../auth.html";
          return;
        }
        const { user } = await getCurrentUser();
        currentUser = user;
        loadBalance();
        renderCountries();

        // Check if user is admin and show admin button
        const isAdmin = await isUserAdmin(user.id);
        if (isAdmin) {
          document.getElementById("adminSection").style.display = "block";
        }

        // Hamburger menu toggle
        const hamburger = document.getElementById("hamburger");
        const sidebar = document.querySelector(".sidebar");

        if (hamburger && sidebar) {
          // Toggle sidebar on hamburger click
          function toggleSidebar(e) {
            if (e) {
              e.stopPropagation();
              e.preventDefault();
            }
            hamburger.classList.toggle("active");
            sidebar.classList.toggle("active");
          }

          hamburger.addEventListener("click", toggleSidebar);
          hamburger.addEventListener("touchstart", toggleSidebar);

          // Close sidebar when clicking outside
          document.addEventListener(
            "click",
            (e) => {
              const isClickOnHamburger = hamburger.contains(e.target);
              const isClickOnSidebar = sidebar.contains(e.target);

              if (
                !isClickOnHamburger &&
                !isClickOnSidebar &&
                sidebar.classList.contains("active")
              ) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            },
            true
          );

          // Close sidebar when clicking a link on mobile
          document.querySelectorAll(".sidebar-link").forEach((link) => {
            link.addEventListener("click", () => {
              if (window.innerWidth <= 768) {
                hamburger.classList.remove("active");
                sidebar.classList.remove("active");
              }
            });
          });
        }

        // Logout button handler
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            const success = await signOut();
            if (success) {
              window.location.href = "../auth.html";
            } else {
              alert("Logout failed. Please try again.");
            }
          });
        }
      });

      function renderCountries(filtered = null) {
        const grid = document.getElementById("countriesGrid");
        grid.innerHTML = "";

        const data = filtered || countriesData;

        data.forEach((country) => {
          const card = document.createElement("div");
          card.className = "country-card";
          const avgPrice = Math.round(
            country.prices.reduce((a, b) => a + b, 0) / country.prices.length
          );

          card.innerHTML = `
                    <div class="country-header">
                        <div>
                            <div class="country-flag">${country.flag}</div>
                            <div class="country-name">${country.name}</div>
                        </div>
                    </div>
                    <div class="numbers-list">
                        ${country.prices
                          .map(
                            (price, i) => `
                            <div class="number-item">
                                <div class="number-info">
                                    <span class="number-phone">+${
                                      country.code
                                    }${String(i + 1).padStart(10, "0")}</span>
                                    <span class="number-price">â‚¦${price}</span>
                                </div>
                                <button class="btn-buy" onclick="buyNumber('+${
                                  country.code
                                }${String(i + 1).padStart(10, "0")}', '${
                              country.name
                            }', ${price}, '${country.code}')">Buy</button>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                `;
          grid.appendChild(card);
        });
      }

      function filterCountries() {
        const selected = document.getElementById("countryFilter").value;
        if (selected) {
          const filtered = countriesData.filter((c) => c.name === selected);
          renderCountries(filtered);
        } else {
          renderCountries();
        }
      }

      function filterByPrice() {
        const range = document.getElementById("priceFilter").value;
        let filtered = countriesData;

        if (range === "low") {
          filtered = countriesData.filter((c) => Math.min(...c.prices) < 200);
        } else if (range === "medium") {
          filtered = countriesData.filter((c) => {
            const min = Math.min(...c.prices);
            const max = Math.max(...c.prices);
            return (min >= 200 && min <= 500) || (max >= 200 && max <= 500);
          });
        } else if (range === "high") {
          filtered = countriesData.filter((c) => Math.max(...c.prices) > 500);
        }

        renderCountries(filtered);
      }

      async function buyNumber(phoneNumber, country, price, countryCode) {
        const wallet = await getWallet(currentUser.id);

        if (wallet.balance < price) {
          showWarning(
            `Insufficient balance. You need â‚¦${price} but have â‚¦${wallet.balance}`
          );
          return;
        }

        try {
          await updateWallet(currentUser.id, wallet.balance - price);
          await createTransaction(
            currentUser.id,
            "debit",
            price,
            `Purchased ${country} number: ${phoneNumber}`,
            "sms_number_purchase"
          );
          await addSMSNumber(
            currentUser.id,
            phoneNumber,
            country,
            countryCode,
            "international",
            price
          );

          showSuccess(`Number purchased successfully! ${phoneNumber}`);
          loadBalance();
        } catch (error) {
          console.error("Purchase error:", error);
          showError("Purchase failed. Please try again.");
        }
      }

      async function loadBalance() {
        try {
          const wallet = await getWallet(currentUser.id);
          document.getElementById(
            "balanceDisplay"
          ).textContent = `â‚¦${wallet.balance.toFixed(2)}`;

          if (wallet.balance < 100) {
            document.getElementById("balanceWarning").style.display = "block";
            document.getElementById("balanceWarning").textContent =
              "âš ï¸ Low balance. Top up your wallet to continue purchasing.";
          }
        } catch (error) {
          console.error("Error loading balance:", error);
        }
      }

      function showSuccess(msg) {
        alert("âœ“ " + msg);
      }

      function showError(msg) {
        alert("âœ— " + msg);
      }

      function showWarning(msg) {
        alert("âš ï¸ " + msg);
      }
    </script>
  </body>
</html>
