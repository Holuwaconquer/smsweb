<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pricing Management - Admin</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <style>
      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
        margin-top: 24px;
      }

      .pricing-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
      }

      .pricing-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }

      .pricing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e2e8f0;
      }

      .pricing-title {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
      }

      .pricing-category {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .category-sms {
        background: #e6f7ff;
        color: #0050b3;
      }

      .category-social {
        background: #f6ffed;
        color: #237804;
      }

      .category-log {
        background: #fff1f0;
        color: #a8071a;
      }

      .pricing-detail {
        margin-bottom: 16px;
      }

      .pricing-label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .pricing-value {
        font-size: 16px;
        color: #2d3748;
        font-weight: 600;
      }

      .price-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .price-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .profit-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
      }

      .profit-positive {
        background: linear-gradient(135deg, #d4f4dd 0%, #b9f6ca 100%);
        color: #1b5e20;
      }

      .profit-negative {
        background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
        color: #b71c1c;
      }

      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      .btn-save {
        flex: 1;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-delete {
        padding: 12px 20px;
        background: #f5576c;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-delete:hover {
        background: #d63447;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e0;
        transition: 0.4s;
        border-radius: 26px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }

      .add-pricing-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 32px;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        transition: all 0.3s;
        z-index: 100;
      }

      .add-pricing-btn:hover {
        transform: scale(1.1) rotate(90deg);
      }

      .filter-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .filter-tab {
        padding: 10px 20px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .filter-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
      }

      .filter-tab:hover {
        border-color: #667eea;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px;
        border-radius: 16px;
        color: white;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
      }

      .stat-value {
        font-size: 36px;
        font-weight: 800;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <button class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <button
            class="back-button"
            onclick="window.location.href = 'index.html'"
          >
            <span>‚Üê</span>
          </button>
          <div class="logo">
            <div class="logo-icon">F</div>
            <span>Pricing Management</span>
          </div>
        </div>
        <div class="header-right">
          <div class="user-info">
            <span class="user-role">Administrator</span>
          </div>
          <button class="theme-toggle" id="themeToggle">üåô</button>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Admin Menu</div>
        <a href="index.html" class="sidebar-link">
          <span class="sidebar-icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="pricing.html" class="sidebar-link active">
          <span class="sidebar-icon">üí∞</span>
          <span>Pricing Control</span>
        </a>
      </div>
      <div class="sidebar-section">
        <a href="../dashboard/index.html" class="sidebar-link">
          <span class="sidebar-icon">üè†</span>
          <span>Back to Dashboard</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1>üí∞ Pricing Management</h1>
        <p>Control all prices across the platform</p>
      </div>

      <!-- Stats Overview -->
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-value" id="totalServices">0</div>
          <div class="stat-label">Total Services</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeServices">0</div>
          <div class="stat-label">Active Services</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgMarkup">0%</div>
          <div class="stat-label">Avg Markup</div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">
          All Services
        </button>
        <button class="filter-tab" data-filter="sms">SMS Numbers</button>
        <button class="filter-tab" data-filter="social_boost">
          Social Boosts
        </button>
        <button class="filter-tab" data-filter="account_log">
          Account Logs
        </button>
      </div>

      <!-- Pricing Grid -->
      <div class="pricing-grid" id="pricingGrid">
        <!-- Pricing cards will be loaded here -->
      </div>

      <!-- Add New Pricing Button -->
      <button
        class="add-pricing-btn"
        id="addPricingBtn"
        title="Add New Service"
      >
        +
      </button>
    </main>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Scripts -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/payment.js"></script>
    <script src="../js/admin.js"></script>

    <script>
      let allPricing = [];
      let currentFilter = "all";

      document.addEventListener("DOMContentLoaded", async () => {
        await checkAdminAuth();
        await loadPricing();
        initUI();
      });

      async function checkAdminAuth() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = "../auth.html";
          return;
        }

        const { data: profile } = await supabase
          .from("profiles")
          .select("is_admin")
          .eq("id", user.id)
          .single();

        if (!profile || !profile.is_admin) {
          alert("Access denied. Admin only.");
          window.location.href = "../dashboard/index.html";
        }
      }

      async function loadPricing() {
        try {
          const { data, error } = await supabase
            .from("pricing")
            .select("*")
            .order("category", { ascending: true })
            .order("service_name", { ascending: true });

          if (error) throw error;

          allPricing = data || [];
          updateStats();
          renderPricing();
        } catch (error) {
          console.error("Error loading pricing:", error);
          alert("Error loading pricing data");
        }
      }

      function updateStats() {
        const total = allPricing.length;
        const active = allPricing.filter((p) => p.is_active).length;
        const avgMarkup =
          allPricing.reduce((sum, p) => sum + (p.markup_percentage || 0), 0) /
          total;

        document.getElementById("totalServices").textContent = total;
        document.getElementById("activeServices").textContent = active;
        document.getElementById("avgMarkup").textContent =
          avgMarkup.toFixed(1) + "%";
      }

      function renderPricing() {
        const grid = document.getElementById("pricingGrid");
        const filtered =
          currentFilter === "all"
            ? allPricing
            : allPricing.filter((p) => p.category === currentFilter);

        if (filtered.length === 0) {
          grid.innerHTML =
            '<p style="text-align: center; color: #718096; grid-column: 1/-1;">No services found</p>';
          return;
        }

        grid.innerHTML = filtered
          .map(
            (pricing) => `
                <div class="pricing-card" data-id="${pricing.id}">
                    <div class="pricing-header">
                        <div class="pricing-title">${formatServiceName(pricing.service_name)}${pricing.country ? ` (${pricing.country})` : ""}</div>
                        <span class="pricing-category category-${pricing.category.replace("_", "")}">
                            ${pricing.category.replace("_", " ")}
                        </span>
                    </div>

                    <div class="pricing-detail">
                        <div class="pricing-label">Base Price (Our Cost)</div>
                        <input type="number" 
                               class="price-input base-price" 
                               value="${pricing.base_price}" 
                               data-id="${pricing.id}"
                               step="0.01">
                    </div>

                    <div class="pricing-detail">
                        <div class="pricing-label">Selling Price (Customer Pays)</div>
                        <input type="number" 
                               class="price-input selling-price" 
                               value="${pricing.selling_price}" 
                               data-id="${pricing.id}"
                               step="0.01">
                    </div>

                    <div class="pricing-detail">
                        <div class="pricing-label">Profit & Markup</div>
                        <div class="profit-badge ${pricing.selling_price - pricing.base_price > 0 ? "profit-positive" : "profit-negative"}">
                            ‚Ç¶${(pricing.selling_price - pricing.base_price).toFixed(2)} 
                            (${pricing.markup_percentage ? pricing.markup_percentage.toFixed(1) : "0"}%)
                        </div>
                    </div>

                    <div class="pricing-detail">
                        <div class="pricing-label">Active Status</div>
                        <label class="toggle-switch">
                            <input type="checkbox" 
                                   class="status-toggle" 
                                   data-id="${pricing.id}" 
                                   ${pricing.is_active ? "checked" : ""}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-save" onclick="savePricing('${pricing.id}')">
                            üíæ Save Changes
                        </button>
                        <button class="btn-delete" onclick="deletePricing('${pricing.id}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function formatServiceName(name) {
        return name
          .split("_")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      async function savePricing(id) {
        const card = document.querySelector(`[data-id="${id}"]`);
        const basePrice = parseFloat(card.querySelector(".base-price").value);
        const sellingPrice = parseFloat(
          card.querySelector(".selling-price").value,
        );
        const isActive = card.querySelector(".status-toggle").checked;

        try {
          const { error } = await supabase
            .from("pricing")
            .update({
              base_price: basePrice,
              selling_price: sellingPrice,
              is_active: isActive,
            })
            .eq("id", id);

          if (error) throw error;

          alert("‚úÖ Pricing updated successfully!");
          await loadPricing();
        } catch (error) {
          console.error("Error updating pricing:", error);
          alert("‚ùå Error updating pricing: " + error.message);
        }
      }

      async function deletePricing(id) {
        if (!confirm("Are you sure you want to delete this pricing entry?")) {
          return;
        }

        try {
          const { error } = await supabase
            .from("pricing")
            .delete()
            .eq("id", id);

          if (error) throw error;

          alert("‚úÖ Pricing deleted successfully!");
          await loadPricing();
        } catch (error) {
          console.error("Error deleting pricing:", error);
          alert("‚ùå Error deleting pricing: " + error.message);
        }
      }

      function initUI() {
        // Filter tabs
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document
              .querySelectorAll(".filter-tab")
              .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            currentFilter = tab.dataset.filter;
            renderPricing();
          });
        });

        // Add pricing button
        document
          .getElementById("addPricingBtn")
          .addEventListener("click", () => {
            showAddPricingModal();
          });

        // Hamburger
        document.getElementById("hamburger").addEventListener("click", () => {
          document.getElementById("hamburger").classList.toggle("active");
          document.getElementById("sidebar").classList.toggle("active");
        });

        // Theme toggle
        document.getElementById("themeToggle").addEventListener("click", () => {
          document.body.classList.toggle("dark-theme");
        });
      }

      function showAddPricingModal() {
        const category = prompt("Category (sms, social_boost, account_log):");
        if (!category) return;

        const serviceName = prompt(
          "Service name (e.g., whatsapp, instagram_followers, netflix):",
        );
        if (!serviceName) return;

        const country =
          category === "sms"
            ? prompt("Country code (e.g., US, NG, GB):")
            : null;
        const basePrice = parseFloat(prompt("Base price (what you pay):"));
        const sellingPrice = parseFloat(
          prompt("Selling price (what customer pays):"),
        );

        if (!basePrice || !sellingPrice) {
          alert("Invalid prices");
          return;
        }

        addNewPricing(category, serviceName, country, basePrice, sellingPrice);
      }

      async function addNewPricing(
        category,
        serviceName,
        country,
        basePrice,
        sellingPrice,
      ) {
        try {
          const { error } = await supabase.from("pricing").insert({
            category,
            service_name: serviceName,
            country,
            base_price: basePrice,
            selling_price: sellingPrice,
            is_active: true,
          });

          if (error) throw error;

          alert("‚úÖ New pricing added successfully!");
          await loadPricing();
        } catch (error) {
          console.error("Error adding pricing:", error);
          alert("‚ùå Error adding pricing: " + error.message);
        }
      }
    </script>
  </body>
</html>
