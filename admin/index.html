<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Femzy</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 25px;
      }

      .admin-header h1 {
        margin: 0;
        font-size: 28px;
      }

      .admin-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .metric-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .metric-value {
        font-size: 36px;
        font-weight: 700;
        color: #2196f3;
        margin-bottom: 8px;
      }

      .metric-label {
        color: #666;
        font-size: 14px;
        font-weight: 600;
      }

      .metric-card.revenue .metric-value {
        color: #4caf50;
      }

      .metric-card.users .metric-value {
        color: #ff9800;
      }

      .metric-card.numbers .metric-value {
        color: #9c27b0;
      }

      .metric-card.boosts .metric-value {
        color: #f44336;
      }

      .container-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 25px;
      }

      @media (max-width: 1024px) {
        .container-section {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        margin-top: 0;
        color: #333;
        font-size: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
        font-size: 13px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        font-family: inherit;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .btn-submit {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        width: 100%;
        transition: background 0.3s;
        margin-top: 10px;
      }

      .btn-submit:hover {
        background: #45a049;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .data-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        font-size: 12px;
        color: #333;
      }

      .data-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 12px;
      }

      .data-table tbody tr:hover {
        background: #f9f9f9;
      }

      .user-link {
        color: #2196f3;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
      }

      .user-link:hover {
        text-decoration: underline;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-completed {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .btn-view {
        background: #2196f3;
        color: white;
        padding: 4px 8px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.3s;
      }

      .btn-view:hover {
        background: #1976d2;
      }

      .btn-delete-admin {
        background: #f44336;
        color: white;
        padding: 4px 8px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        margin-left: 5px;
        transition: background 0.3s;
      }

      .btn-delete-admin:hover {
        background: #d32f2f;
      }

      .empty-state {
        padding: 30px 20px;
        text-align: center;
        color: #999;
        font-size: 13px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #999;
      }

      .stats-mini {
        display: flex;
        justify-content: space-around;
        padding: 15px 0;
        border-top: 1px solid #eee;
        font-size: 12px;
      }

      .stats-mini-item {
        text-align: center;
      }

      .stats-mini-value {
        font-weight: 700;
        color: #333;
        font-size: 16px;
      }

      .stats-mini-label {
        color: #999;
      }

      .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        color: #856404;
        font-size: 12px;
      }

      .success-message {
        background: #d4edda;
        border: 1px solid #28a745;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
        font-size: 12px;
      }

      .success-message.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">Femzy Admin</div>
        <nav class="nav-menu">
          <a
            href="#overview"
            class="nav-link active"
            onclick="showSection('overview')"
            >Overview</a
          >
          <a href="#users" class="nav-link" onclick="showSection('users')"
            >Users</a
          >
          <a
            href="#inventory"
            class="nav-link"
            onclick="showSection('inventory')"
            >Inventory</a
          >
          <a
            href="#transactions"
            class="nav-link"
            onclick="showSection('transactions')"
            >Transactions</a
          >
          <a href="#settings" class="nav-link" onclick="showSection('settings')"
            >Settings</a
          >
        </nav>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="header-right">
            <div class="user-menu">
              Admin Panel ‚Ä¢ <span id="adminEmail">Admin</span>
            </div>
          </div>
        </header>

        <div class="content">
          <!-- Overview Section -->
          <div id="overview-section">
            <div class="admin-header">
              <h1>üìä Admin Dashboard</h1>
              <p>System Overview & Management</p>
            </div>

            <!-- Key Metrics -->
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value" id="totalUsers">0</div>
                <div class="metric-label">Total Users</div>
              </div>
              <div class="metric-card revenue">
                <div class="metric-value">
                  ‚Ç¶<span id="totalRevenue">0</span>
                </div>
                <div class="metric-label">Total Revenue</div>
              </div>
              <div class="metric-card users">
                <div class="metric-value" id="activeSessions">0</div>
                <div class="metric-label">Active Sessions</div>
              </div>
              <div class="metric-card numbers">
                <div class="metric-value" id="activeNumbers">0</div>
                <div class="metric-label">Active Numbers</div>
              </div>
            </div>

            <!-- Recent Data -->
            <div class="container-section">
              <!-- Recent Users -->
              <div class="panel">
                <h2>Recent Users</h2>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Email</th>
                      <th>Joined</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="recentUsersBody">
                    <tr>
                      <td colspan="3" class="empty-state">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Recent Transactions -->
              <div class="panel">
                <h2>Recent Transactions</h2>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="recentTransactionsBody">
                    <tr>
                      <td colspan="4" class="empty-state">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Statistics -->
            <div class="panel">
              <h2>Daily Statistics</h2>
              <div class="stats-mini">
                <div class="stats-mini-item">
                  <div class="stats-mini-value" id="smsSentToday">0</div>
                  <div class="stats-mini-label">SMS Sent</div>
                </div>
                <div class="stats-mini-item">
                  <div class="stats-mini-value" id="logsSoldToday">0</div>
                  <div class="stats-mini-label">Logs Sold</div>
                </div>
                <div class="stats-mini-item">
                  <div class="stats-mini-value" id="boostsToday">0</div>
                  <div class="stats-mini-label">Boost Orders</div>
                </div>
                <div class="stats-mini-item">
                  <div class="stats-mini-value">
                    ‚Ç¶<span id="revenueToday">0</span>
                  </div>
                  <div class="stats-mini-label">Revenue Today</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Section -->
          <div id="users-section" style="display: none">
            <h1>User Management</h1>

            <div class="panel">
              <h2>All Users</h2>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Wallet Balance</th>
                    <th>Total Spent</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allUsersBody">
                  <tr>
                    <td colspan="6" class="empty-state">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Inventory Section -->
          <div id="inventory-section" style="display: none">
            <h1>System Inventory</h1>

            <div class="container-section">
              <!-- Add Numbers -->
              <div class="panel">
                <h2>Add SMS Numbers</h2>
                <div class="warning-box">
                  ‚ö†Ô∏è Add numbers that will be available for purchase
                </div>
                <div id="successMessage" class="success-message">
                  ‚úì Number added successfully!
                </div>
                <form id="addNumberForm">
                  <div class="form-group">
                    <label>Country</label>
                    <select id="inventoryCountry" required>
                      <option value="">Select Country</option>
                      <option value="US">United States</option>
                      <option value="GB">United Kingdom</option>
                      <option value="NG">Nigeria</option>
                    </select>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Phone Number</label>
                      <input
                        type="text"
                        id="inventoryPhone"
                        placeholder="+1234567890"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label>Service</label>
                      <select id="inventoryService" required>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telegram">Telegram</option>
                        <option value="instagram">Instagram</option>
                        <option value="google">Google</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Price (‚Ç¶)</label>
                    <input
                      type="number"
                      id="inventoryPrice"
                      placeholder="500"
                      min="0"
                      required
                    />
                  </div>
                  <button type="submit" class="btn-submit">
                    Add to Inventory
                  </button>
                </form>
              </div>

              <!-- System Stats -->
              <div class="panel">
                <h2>Inventory Stats</h2>
                <div class="stats-mini">
                  <div class="stats-mini-item">
                    <div class="stats-mini-value" id="totalNumbers">0</div>
                    <div class="stats-mini-label">Total Numbers</div>
                  </div>
                  <div class="stats-mini-item">
                    <div class="stats-mini-value" id="availableNumbers">0</div>
                    <div class="stats-mini-label">Available</div>
                  </div>
                  <div class="stats-mini-item">
                    <div class="stats-mini-value" id="usedNumbers">0</div>
                    <div class="stats-mini-label">In Use</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Transactions Section -->
          <div id="transactions-section" style="display: none">
            <h1>Transaction Management</h1>

            <div class="panel">
              <h2>All Transactions</h2>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="allTransactionsBody">
                  <tr>
                    <td colspan="6" class="empty-state">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Settings Section -->
          <div id="settings-section" style="display: none">
            <h1>Settings</h1>

            <div class="panel">
              <h2>System Configuration</h2>
              <div class="form-group">
                <label>Platform Name</label>
                <input type="text" value="Femzy" disabled />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>SMS API Key</label>
                  <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" disabled />
                </div>
                <div class="form-group">
                  <label>SMM Panel Key</label>
                  <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" disabled />
                </div>
              </div>
              <button class="btn-submit" disabled>
                Update Settings (Coming Soon)
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
      let currentAdmin = null;

      document.addEventListener("DOMContentLoaded", async () => {
        if (!(await checkAuth())) return;

        const { user } = await getCurrentUser();
        currentAdmin = user;

        // Check if admin
        const profile = await getProfile(user.id);
        if (!profile.is_admin) {
          alert("Access Denied: Admin privileges required");
          window.location.href = "../auth.html";
          return;
        }

        document.getElementById("adminEmail").textContent = user.email;
        loadDashboardData();

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
      });

      async function loadDashboardData() {
        try {
          // Load all data
          const allProfiles = await getAllProfiles();
          const allTransactions = await getAllTransactions();
          const allNumbers = await getAllSMSNumbers();

          // Update metrics
          document.getElementById("totalUsers").textContent =
            allProfiles.length;
          document.getElementById("activeSessions").textContent = Math.floor(
            allProfiles.length * 0.6
          ); // Estimated

          const totalRevenue = allTransactions
            .filter((t) => t.type === "debit" && t.status === "completed")
            .reduce((sum, t) => sum + t.amount, 0);
          document.getElementById("totalRevenue").textContent =
            totalRevenue.toFixed(2);

          const activeNumbers = allNumbers.filter(
            (n) => n.status === "active"
          ).length;
          document.getElementById("activeNumbers").textContent = activeNumbers;

          // Load recent users
          displayRecentUsers(allProfiles.slice(0, 5));

          // Load recent transactions
          displayRecentTransactions(allTransactions.slice(0, 5));

          // Update daily stats
          updateDailyStats(allTransactions, allNumbers);
        } catch (error) {
          console.error("Error loading dashboard:", error);
        }
      }

      function displayRecentUsers(users) {
        const tbody = document.getElementById("recentUsersBody");
        if (users.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="3" class="empty-state">No users found</td></tr>';
          return;
        }

        let html = "";
        users.forEach((user) => {
          const date = new Date(user.created_at).toLocaleDateString();
          html += `
                    <tr>
                        <td><span class="user-link">${user.email}</span></td>
                        <td>${date}</td>
                        <td><button class="btn-view" onclick="viewUser('${user.id}')">View</button></td>
                    </tr>
                `;
        });
        tbody.innerHTML = html;
      }

      function displayRecentTransactions(transactions) {
        const tbody = document.getElementById("recentTransactionsBody");
        if (transactions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="empty-state">No transactions found</td></tr>';
          return;
        }

        let html = "";
        transactions.forEach((trans) => {
          const date = new Date(trans.created_at).toLocaleString();
          html += `
                    <tr>
                        <td>${date}</td>
                        <td>${trans.type}</td>
                        <td>‚Ç¶${trans.amount.toFixed(2)}</td>
                        <td><span class="status-badge status-${trans.status}">${
            trans.status
          }</span></td>
                    </tr>
                `;
        });
        tbody.innerHTML = html;
      }

      function updateDailyStats(transactions, numbers) {
        const today = new Date().toDateString();
        const todayTransactions = transactions.filter(
          (t) => new Date(t.created_at).toDateString() === today
        );

        const smsSent = numbers.filter(
          (n) => new Date(n.created_at).toDateString() === today
        ).length;
        document.getElementById("smsSentToday").textContent = smsSent;

        const logsSold = todayTransactions.filter((t) =>
          t.description.includes("account")
        ).length;
        document.getElementById("logsSoldToday").textContent = logsSold;

        const boosts = todayTransactions.filter((t) =>
          t.description.includes("boost")
        ).length;
        document.getElementById("boostsToday").textContent = boosts;

        const revenue = todayTransactions
          .filter((t) => t.type === "debit" && t.status === "completed")
          .reduce((sum, t) => sum + t.amount, 0);
        document.getElementById("revenueToday").textContent =
          revenue.toFixed(2);
      }

      function showSection(section) {
        // Hide all sections
        document.querySelectorAll('[id$="-section"]').forEach((el) => {
          el.style.display = "none";
        });

        // Show selected section
        document.getElementById(section + "-section").style.display = "block";

        // Update nav active state
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        event.target.classList.add("active");

        // Load section-specific data
        if (section === "users") loadAllUsers();
        else if (section === "transactions") loadAllTransactions();
      }

      async function loadAllUsers() {
        try {
          const users = await getAllProfiles();
          const tbody = document.getElementById("allUsersBody");

          if (users.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
            return;
          }

          let html = "";
          users.forEach((user) => {
            html += `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.username || "N/A"}</td>
                            <td>‚Ç¶0.00</td>
                            <td>‚Ç¶0.00</td>
                            <td>${new Date(
                              user.created_at
                            ).toLocaleDateString()}</td>
                            <td>
                                <button class="btn-view" onclick="viewUser('${
                                  user.id
                                }')">View</button>
                                <button class="btn-delete-admin" onclick="deleteUser('${
                                  user.id
                                }')">Delete</button>
                            </td>
                        </tr>
                    `;
          });
          tbody.innerHTML = html;
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      async function loadAllTransactions() {
        try {
          const transactions = await getAllTransactions();
          const tbody = document.getElementById("allTransactionsBody");

          if (transactions.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state">No transactions found</td></tr>';
            return;
          }

          let html = "";
          transactions.forEach((trans) => {
            html += `
                        <tr>
                            <td>${new Date(
                              trans.created_at
                            ).toLocaleString()}</td>
                            <td>${trans.user_id.substring(0, 8)}...</td>
                            <td>${trans.type}</td>
                            <td>‚Ç¶${trans.amount.toFixed(2)}</td>
                            <td>${trans.description || "N/A"}</td>
                            <td><span class="status-badge status-${
                              trans.status
                            }">${trans.status}</span></td>
                        </tr>
                    `;
          });
          tbody.innerHTML = html;
        } catch (error) {
          console.error("Error loading transactions:", error);
        }
      }

      function viewUser(userId) {
        alert(`View user details for ID: ${userId}\n(Feature coming soon)`);
      }

      function deleteUser(userId) {
        if (confirm("Are you sure? This action cannot be undone.")) {
          alert("User deletion would be implemented here.");
        }
      }

      document
        .getElementById("addNumberForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const country = document.getElementById("inventoryCountry").value;
          const phone = document.getElementById("inventoryPhone").value;
          const service = document.getElementById("inventoryService").value;
          const price = parseFloat(
            document.getElementById("inventoryPrice").value
          );

          // Show success message
          const msg = document.getElementById("successMessage");
          msg.classList.add("show");
          setTimeout(() => msg.classList.remove("show"), 3000);

          // Reset form
          document.getElementById("addNumberForm").reset();
        });

      document.getElementById("hamburger").addEventListener("click", () => {
        document.getElementById("hamburger").classList.toggle("active");
        document.querySelector(".sidebar").classList.toggle("active");
      });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          await signOut();
          window.location.href = "../auth.html";
        });
    </script>
  </body>
</html>
